#include "global.h"

const unsigned char race_name[] =
{
  //Capital City
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x02,0x7E,0x11,0xFF,0x1F,0xFF,0x10,0xF0,0x10,0xF0,0x11,0xFF,0x83,0xFF,0x7E,0x7E,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x02,0x7E,0x11,0xFF,0x11,0xFF,0x01,0xFF,0x11,0xFF,0x11,0xFF,0x11,0xFF,0xFF,0xFF,
  0x00,0x07,0x01,0x0F,0x01,0x0F,0x01,0x0F,0x01,0x0F,0x01,0x0F,0x08,0x0F,0x07,0x07,
  0x02,0xFE,0x11,0xFF,0x11,0xFF,0x03,0xFF,0x1E,0xFE,0x10,0xF0,0x10,0xF0,0xF0,0xF0,
  0x20,0xE3,0x10,0xF3,0xF0,0xF3,0x00,0x03,0x00,0x03,0x10,0xF3,0x30,0xF3,0xE3,0xE3,
  0x04,0x3C,0x04,0x3C,0x04,0x3C,0x04,0x3C,0x04,0x3C,0x04,0x3C,0x04,0x3C,0x3C,0x3C,
  0x40,0xCF,0x4C,0xCF,0x40,0xC3,0x40,0xC3,0x40,0xC3,0x40,0xC3,0x40,0xC3,0xC3,0xC3,
  0x01,0xFF,0xC7,0xFF,0x04,0x3C,0x04,0x3C,0x04,0x3C,0x04,0x3C,0x04,0x3C,0x3C,0x3C,
  0x11,0xFF,0x71,0xFF,0x48,0xCF,0x44,0xC7,0x40,0xC3,0x40,0xC3,0x40,0xC3,0xC3,0xC3,
  0x02,0x7E,0x11,0xFF,0x11,0xFF,0x01,0xFF,0x11,0xFF,0x11,0xFF,0x11,0xFF,0xFF,0xFF,
  0x10,0xF0,0x10,0xF0,0x30,0xF0,0x60,0xE0,0x40,0xC0,0x40,0xC0,0x40,0xC0,0xC0,0xC0,
  0x10,0xF0,0x10,0xF0,0x10,0xF0,0x10,0xF0,0x10,0xF0,0x10,0xF0,0x01,0xFF,0xFF,0xFF,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  //Sunny Desert  
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x0F,0x01,0x0F,0x01,0x0F,0x01,0x0F,0x01,0x0F,0x01,0x0F,0x00,0x0F,0x0F,0x0F,
  0x02,0x7E,0x11,0xFF,0x1F,0xFF,0x82,0xFE,0x71,0x7F,0x11,0xFF,0x83,0xFF,0x7E,0x7E,
  0x20,0xEF,0x11,0xFF,0x11,0xFF,0x10,0xFF,0x11,0xFF,0x11,0xFF,0x30,0xFF,0xEF,0xEF,
  0x11,0xFF,0x11,0xFF,0x11,0xFF,0x11,0xFF,0x11,0xFF,0x11,0xFF,0x83,0xFF,0x7E,0x7E,
  0x10,0xF7,0xF1,0xFF,0x01,0x0F,0x48,0xCF,0xC7,0xC7,0x01,0x0F,0x18,0xFF,0xF7,0xF7,
  0x02,0xFE,0x11,0xFF,0x11,0xFF,0x11,0xFF,0x11,0xFF,0x11,0xFF,0x11,0xFF,0xFF,0xFF,
  0x20,0xEF,0x11,0xFF,0xF1,0xFF,0x20,0xEF,0x11,0xFF,0x11,0xFF,0x30,0xFF,0xEF,0xEF,
  0x02,0xFE,0x11,0xFF,0x11,0xFF,0x11,0xFF,0x11,0xFF,0x11,0xFF,0x11,0xFF,0xFF,0xFF,
  0x10,0xFF,0xF1,0xFF,0x01,0x0F,0x40,0xCF,0xC1,0xCF,0x01,0x0F,0x11,0xFF,0xFF,0xFF,
  0x11,0xFF,0x11,0xFF,0x83,0xFF,0x46,0x7E,0x04,0x3C,0x04,0x3C,0x04,0x3C,0x3C,0x3C,
  0x20,0xEF,0x1C,0xFF,0x10,0xF3,0x20,0xE3,0x10,0xF3,0x10,0xF3,0x10,0xF3,0xF3,0xF3,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x10,0xF0,0x70,0xF0,0x40,0xC0,0x40,0xC0,0x40,0xC0,0x40,0xC0,0x40,0xC0,0xC0,0xC0,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  //High Mountains
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x21,0xE7,0x11,0xFF,0x01,0xFF,0x11,0xFF,0x11,0xFF,0x11,0xFF,0x11,0xFF,0xFF,0xFF,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x02,0x7E,0x11,0xFF,0x11,0xFF,0x11,0xFF,0x11,0xFF,0x11,0xFF,0x83,0xFF,0x7E,0x7E,
  0x01,0x0F,0x01,0x0F,0x01,0x0F,0x00,0x0F,0x01,0x0F,0x01,0x0F,0x01,0x0F,0x0F,0x0F,
  0x11,0xFF,0x11,0xFF,0x11,0xFF,0x11,0xFF,0x11,0xFF,0x11,0xFF,0x83,0xFF,0x7E,0x7E,
  0x10,0xF3,0x10,0xF3,0x10,0xF3,0x10,0xF3,0x10,0xF3,0x10,0xF3,0x10,0xF3,0xF3,0xF3,
  0x02,0xFE,0x11,0xFF,0x11,0xFF,0x11,0xFF,0x11,0xFF,0x11,0xFF,0x11,0xFF,0xFF,0xFF,
  0x40,0xC7,0x41,0xCF,0x41,0xCF,0x41,0xCF,0x41,0xCF,0x41,0xCF,0x48,0xCF,0xC7,0xC7,
  0x01,0xFF,0xC7,0xFF,0x04,0x3C,0x04,0x3C,0x04,0x3C,0x04,0x3C,0x04,0x3C,0x3C,0x3C,
  0x21,0xEF,0x11,0xFF,0xF1,0xFF,0x10,0xFF,0x11,0xFF,0x11,0xFF,0x31,0xFF,0xEF,0xEF,
  0x02,0x7E,0x11,0xFF,0x11,0xFF,0x01,0xFF,0x11,0xFF,0x11,0xFF,0x11,0xFF,0xFF,0xFF,
  0x10,0xF0,0x10,0xF0,0x10,0xF0,0x10,0xF0,0x10,0xF0,0x10,0xF0,0x10,0xF0,0xF0,0xF0,
  0x04,0x3C,0x04,0x3C,0x04,0x3C,0x04,0x3C,0x04,0x3C,0x04,0x3C,0x04,0x3C,0x3C,0x3C,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x02,0xFE,0x11,0xFF,0x11,0xFF,0x11,0xFF,0x11,0xFF,0x11,0xFF,0x11,0xFF,0xFF,0xFF,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x02,0x7E,0x11,0xFF,0x1F,0xFF,0x82,0xFE,0x71,0x7F,0x11,0xFF,0x83,0xFF,0x7E,0x7E,
  //Blue Ocean
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x0F,0x01,0x0F,0x01,0x0F,0x00,0x0F,0x01,0x0F,0x01,0x0F,0x00,0x0F,0x0F,0x0F,
  0x02,0x7E,0x11,0xFF,0x11,0xFF,0x11,0xFF,0x11,0xFF,0x11,0xFF,0x83,0xFF,0x7E,0x7E,
  0x21,0xEF,0x11,0xFF,0x11,0xFF,0x21,0xEF,0x11,0xFF,0x11,0xFF,0x30,0xFF,0xEF,0xEF,
  0x02,0x7E,0x11,0xFF,0x1F,0xFF,0x10,0xF0,0x10,0xF0,0x11,0xFF,0x83,0xFF,0x7E,0x7E,
  0x01,0x0F,0x01,0x0F,0x01,0x0F,0x01,0x0F,0x01,0x0F,0x01,0x0F,0x18,0xFF,0xF7,0xF7,
  0x01,0xFF,0x1F,0xFF,0x10,0xF0,0x04,0xFC,0x1C,0xFC,0x10,0xF0,0x01,0xFF,0xFF,0xFF,
  0x10,0xFF,0x11,0xFF,0x11,0xFF,0x10,0xFF,0x11,0xFF,0x11,0xFF,0x30,0xFF,0xEF,0xEF,
  0x02,0x7E,0x11,0xFF,0x11,0xFF,0x01,0xFF,0x11,0xFF,0x11,0xFF,0x11,0xFF,0xFF,0xFF,
  0x10,0xF0,0xF0,0xF0,0x00,0x00,0x40,0xC0,0xC0,0xC0,0x00,0x00,0x10,0xF0,0xF0,0xF0,
  0x02,0xFE,0x11,0xFF,0x11,0xFF,0x11,0xFF,0x11,0xFF,0x11,0xFF,0x11,0xFF,0xFF,0xFF,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};

const unsigned char curve_data[] =
{ 
  0x4F,0x4D,0x4B,0x49,0x48,0x46,0x45,0x44,0x42,0x41,0x40,0x3F,0x3E,0x3E,0x3D,0x3C,
  0x3B,0x3B,0x3A,0x39,0x39,0x38,0x38,0x37,0x37,0x36,0x36,0x35,0x35,0x35,0x34,0x34,
  0x34,0x33,0x33,0x33,0x32,0x32,0x32,0x31,0x31,0x31,0x31,0x31,0x30,0x30,0x30,0x30,
  0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,
  0x47,0x46,0x44,0x42,0x41,0x40,0x3F,0x3E,0x3D,0x3C,0x3B,0x3A,0x3A,0x39,0x39,0x38,
  0x37,0x37,0x37,0x36,0x36,0x35,0x35,0x34,0x34,0x34,0x33,0x33,0x33,0x33,0x32,0x32,
  0x32,0x32,0x32,0x31,0x31,0x31,0x31,0x31,0x31,0x31,0x30,0x30,0x30,0x30,0x30,0x30,
  0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,
  0x3F,0x3E,0x3D,0x3C,0x3B,0x3B,0x3A,0x39,0x39,0x38,0x38,0x37,0x37,0x36,0x36,0x35,
  0x35,0x35,0x34,0x34,0x34,0x33,0x33,0x33,0x33,0x32,0x32,0x32,0x32,0x32,0x31,0x31,
  0x31,0x31,0x31,0x31,0x31,0x31,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,
  0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,
  0x37,0x36,0x36,0x35,0x35,0x35,0x34,0x34,0x34,0x33,0x33,0x33,0x33,0x32,0x32,0x32,
  0x32,0x32,0x32,0x31,0x31,0x31,0x31,0x31,0x31,0x31,0x31,0x31,0x31,0x31,0x30,0x30,
  0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,
  0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,
  0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,
  0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,
  0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,
  0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,
  0x29,0x2A,0x2A,0x2B,0x2B,0x2B,0x2C,0x2C,0x2C,0x2D,0x2D,0x2D,0x2D,0x2E,0x2E,0x2E,
  0x2E,0x2E,0x2E,0x2F,0x2F,0x2F,0x2F,0x2F,0x2F,0x2F,0x2F,0x2F,0x2F,0x2F,0x30,0x30,
  0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,
  0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,
  0x21,0x22,0x23,0x24,0x25,0x25,0x26,0x27,0x27,0x28,0x28,0x29,0x29,0x2A,0x2A,0x2B,
  0x2B,0x2B,0x2C,0x2C,0x2C,0x2D,0x2D,0x2D,0x2D,0x2E,0x2E,0x2E,0x2E,0x2E,0x2F,0x2F,
  0x2F,0x2F,0x2F,0x2F,0x2F,0x2F,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,
  0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,
  0x19,0x1A,0x1C,0x1E,0x1F,0x20,0x21,0x22,0x23,0x24,0x25,0x26,0x26,0x27,0x27,0x28,
  0x29,0x29,0x29,0x2A,0x2A,0x2B,0x2B,0x2C,0x2C,0x2C,0x2D,0x2D,0x2D,0x2D,0x2E,0x2E,
  0x2E,0x2E,0x2E,0x2F,0x2F,0x2F,0x2F,0x2F,0x2F,0x2F,0x30,0x30,0x30,0x30,0x30,0x30,
  0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,
  0x11,0x13,0x15,0x17,0x18,0x1A,0x1B,0x1C,0x1E,0x1F,0x20,0x21,0x22,0x22,0x23,0x24,
  0x25,0x25,0x26,0x27,0x27,0x28,0x28,0x29,0x29,0x2A,0x2A,0x2B,0x2B,0x2B,0x2C,0x2C,
  0x2C,0x2D,0x2D,0x2D,0x2E,0x2E,0x2E,0x2F,0x2F,0x2F,0x2F,0x2F,0x30,0x30,0x30,0x30,
  0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30
};

const unsigned char speed_data[] =
{
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x30,0x00,0x00,0x00,0x00,0x00,0x30,
  0x00,0x00,0x00,0x00,0x00,0x30,0x00,0x00,0x00,0x00,0x00,0x30,0x00,0x00,0x00,0x00,
  0x00,0xFF,0x30,0x00,0x00,0x30,0x00,0x00,0x30,0x00,0x00,0x30,0x00,0x00,0x30,0x00,
  0x00,0x30,0x00,0x00,0x30,0x00,0x00,0x30,0x00,0x00,0xFF,0x30,0x00,0x30,0x00,0x30,
  0x00,0x30,0x00,0x30,0x00,0x30,0x00,0x30,0x00,0x30,0x00,0x30,0x00,0x30,0x00,0x30,
  0x00,0x30,0x00,0xFF,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,
  0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0xFF,0x60,0x30,0x30,
  0x30,0x60,0x30,0x30,0x30,0x60,0x30,0x30,0x30,0x60,0x30,0x30,0x30,0x60,0x30,0x30,
  0x30,0x60,0x30,0x30,0x30,0xFF
};

unsigned char __at (0xD13F) curve[64];
const unsigned char *speed_ptr;
unsigned char *race_ptr;

UBYTE race_number;
UWORD race_score;
UWORD race_count;
UBYTE race_scroll;
UBYTE race_lap;
UBYTE race_state;

BYTE input_acceleration;
BYTE curve_acceleration;
BYTE bounce_acceleration;

BCD minutes;
BCD seconds;
BCD hundredth;
UBYTE hundredth_count;

void update_hud( UBYTE type )
{
	unsigned char buffer[10];
	UBYTE i,j,k;
	BCD value;
	
	switch( type )
	{
		case HUD_SPEED:
			uint2bcd(player_speed,&value);
			bcd2text(&value, 0x13, buffer);
			set_win_tiles(7, 1, 3, 1, &buffer[5]);
			break;
		case HUD_POWER:
			if( (player_power & 0x01) == 1 )
			{
				k = 0x1E;
			} else {
				k = 0x02;
			}
			j = player_power >> 1;
			for( i = 0; i != 7; i++ )
			{
				if( i < j )
				{
					buffer[6-i] = 0x1D;
				} else if( i == j )
				{			
					buffer[6-i] = k;	
				} else {
					buffer[6-i] = 0x02;
				}
				
			}
			set_win_tiles(6, 2, 7, 1, &buffer[0]);
			break;
		case HUD_LAP:
			buffer[0] = 0x13 + race_lap;
			set_win_tiles(10, 3, 1, 1, &buffer[0]);
			break;
		case HUD_TIME:
			if( race_state == RS_RACE )
			{
				if( hundredth == MAKE_BCD(0) )
				{
					if( seconds == MAKE_BCD(0) )
					{
						if( minutes == MAKE_BCD(0) )
						{
							show_message( MSG_TIMEUP );
							race_state = RS_TIMEUP;
							break;
						}
						
						value = MAKE_BCD(1);
						bcd_sub(&minutes,&value);
						bcd2text(&minutes, 0x13, buffer);
						set_win_tiles(6, 0, 1, 1, &buffer[7]);
						
						seconds = MAKE_BCD(60);
					}

					value = MAKE_BCD(1);
					bcd_sub(&seconds,&value);
					bcd2text(&seconds, 0x13, buffer);
					set_win_tiles(8, 0, 2, 1, &buffer[6]);
								
					hundredth = MAKE_BCD(100);
				}
				hundredth_count++;
				if( hundredth_count == 3 )
				{
					hundredth_count = 0;
					value = MAKE_BCD(1);
				} else {
					value = MAKE_BCD(2);
				}
				bcd_sub(&hundredth,&value);
				bcd2text(&hundredth, 0x13, buffer);
				set_win_tiles(11, 0, 2, 1, &buffer[6]);
			}
			break;
	}
}

void init_race()
{
	unsigned char buffer[10];
	UBYTE i;
	UWORD w;
		
	//load sprite tiles
	UNAPACK( sprite_tiles, buf, DATA_BANK);
	set_sprite_data(0,ST_LAST,buf);
	
	//load road tiles
	UNAPACK( road_tiles, buf, DATA_BANK);
	set_bkg_data(64,192,buf);
	
	//set road
	UNAPACK( road_map, buf, DATA_BANK);
	w = 0;
	for( i = 8; i != 32; i++ )
	{
		set_bkg_tiles(0,i,32,1,&buf[w]);
		w += 32;
	}
	move_bkg(48,0);
	
	speed_ptr = &speed_data[0];
	memset(curve,0x30,sizeof(curve));
	
	switch( race_number )
	{
		case RN_RACE1:	//Capital City
			
			//load race name
			set_sprite_data(ST_RACENAME1,18,&race_name[0]);
			
			//load race tiles
			UNAPACK( race1_tiles, buf, DATA_BANK);
			set_bkg_data(0,64,buf);
			
			//set window
			UNAPACK( race1_hud_map, buf, DATA_BANK);
			w = 0;
			for( i = 0; i != 4; i++ )
			{
				set_win_tiles(0,i,20,1,&buf[w]);
				w += 20;
			}
			move_win(7,112);
			
			//set background
			UNAPACK( race1_map, buf, DATA_BANK);
			w = 0;
			for( i = 0; i != 8; i++ )
			{
				set_bkg_tiles(0,i,32,1,&buf[w]);
				w += 32;
			}
			
			//load race
			UNAPACK( race1_data, buf, DATA_BANK);
			race_ptr = &buf[0];
			
			//set time best time
			minutes = MAKE_BCD(2);
			seconds = MAKE_BCD(5);
			hundredth = MAKE_BCD(0);
			hundredth_count = 0;
			break;
		case RN_RACE2:	//Sunny Desert
			
			//load race name
			set_sprite_data(ST_RACENAME1,18,&race_name[288]);
			
			//load race tiles
			UNAPACK( race2_tiles, buf, DATA_BANK);
			set_bkg_data(0,64,buf);
			
			//set window
			UNAPACK( race2_hud_map, buf, DATA_BANK);
			w = 0;
			for( i = 0; i != 4; i++ )
			{
				set_win_tiles(0,i,20,1,&buf[w]);
				w += 20;
			}
			move_win(7,112);
			
			//set background
			UNAPACK( race2_map, buf, DATA_BANK);
			w = 0;
			for( i = 0; i != 8; i++ )
			{
				set_bkg_tiles(0,i,32,1,&buf[w]);
				w += 32;
			}
			
			//load race
			UNAPACK( race2_data, buf, DATA_BANK);
			race_ptr = &buf[0];
			
			//set time
			minutes = MAKE_BCD(2);		
			seconds = MAKE_BCD(30);		
			hundredth = MAKE_BCD(0);
			hundredth_count = 0;
			break;
		case RN_RACE3:	//High Mountains
			
			//load race name
			set_sprite_data(ST_RACENAME1,18,&race_name[576]);
			
			//load race tiles
			UNAPACK( race3_tiles, buf, DATA_BANK);
			set_bkg_data(0,64,buf);
			
			//set window
			UNAPACK( race3_hud_map, buf, DATA_BANK);
			w = 0;
			for( i = 0; i != 4; i++ )
			{
				set_win_tiles(0,i,20,1,&buf[w]);
				w += 20;
			}
			move_win(7,112);
			
			//set background
			UNAPACK( race3_map, buf, DATA_BANK);
			w = 0;
			for( i = 0; i != 8; i++ )
			{
				set_bkg_tiles(0,i,32,1,&buf[w]);
				w += 32;
			}
			
			//load race
			UNAPACK( race3_data, buf, DATA_BANK);
			race_ptr = &buf[0];
			
			//set time
			minutes = MAKE_BCD(2);		
			seconds = MAKE_BCD(0);		
			hundredth = MAKE_BCD(0);
			hundredth_count = 0;
			break;
		case RN_RACE4:	//Blue Ocean
			
			//load race name
			set_sprite_data(ST_RACENAME1,18,&race_name[864]);
			
			//load race tiles
			UNAPACK( race4_tiles, buf, DATA_BANK);
			set_bkg_data(0,64,buf);
			
			//set window
			UNAPACK( race4_hud_map, buf, DATA_BANK);
			w = 0;
			for( i = 0; i != 4; i++ )
			{
				set_win_tiles(0,i,20,1,&buf[w]);
				w += 20;
			}
			move_win(7,112);
			
			//set background
			UNAPACK( race4_map, buf, DATA_BANK);
			w = 0;
			for( i = 0; i != 8; i++ )
			{
				set_bkg_tiles(0,i,32,1,&buf[w]);
				w += 32;
			}
			
			//load race
			UNAPACK( race4_data, buf, DATA_BANK);
			race_ptr = &buf[0];
			
			//set time
			minutes = MAKE_BCD(2);		
			seconds = MAKE_BCD(30);		
			hundredth = MAKE_BCD(0);
			hundredth_count = 0;
			break;
	}
	
	show_message( MSG_RACENAME );
	
	race_score = 0;
	race_count = 0;
	race_scroll = 0;
	race_lap = 1;
	race_state = RS_RACE;
	
	bcd2text(&minutes, 0x13, buffer);
	set_win_tiles(6, 0, 1, 1, &buffer[7]);
	bcd2text(&seconds, 0x13, buffer);
	set_win_tiles(8, 0, 2, 1, &buffer[6]);
		
	input_acceleration = 0;
	curve_acceleration = 0;
	bounce_acceleration = 0;
}

void update_race()
{
	UBYTE i;
	
	//handle race
	race_count += player_speed;
	if( race_count >= 0x03FF )
	{
		race_count -= 0x03FF;
		race_ptr++;
		
		if( (*race_ptr >= 0x09) && (race_state == RS_RACE) )
		{
			race_score++;
		}
		
		switch( *race_ptr )
		{
			case 0x09:
				race_ptr++;
				scroll_sprite(SN_MINI_PLAYER1,1,0);
				break;
			case 0x0A:
				race_ptr++;
				scroll_sprite(SN_MINI_PLAYER1,-1,0);
				break;
			case 0x0B:
				race_ptr++;
				scroll_sprite(SN_MINI_PLAYER1,0,1);
				break;
			case 0x0C:
				race_ptr++;
				scroll_sprite(SN_MINI_PLAYER1,0,-1);
				break;
			case 0x0D:
				race_ptr++;
				scroll_sprite(SN_MINI_PLAYER1,1,1);
				break;
			case 0x0E:
				race_ptr++;
				scroll_sprite(SN_MINI_PLAYER1,-1,1);
				break;
			case 0x0F:
				race_ptr++;
				scroll_sprite(SN_MINI_PLAYER1,1,-1);
				break;
			case 0x10:
				race_ptr++;
				scroll_sprite(SN_MINI_PLAYER1,-1,-1);
				break;
		}
		if( *race_ptr == 0xFF )
		{
			if( race_lap != 2 )
			{
				race_lap++;
			} else {
				if( race_state == RS_RACE )
				{
					show_message( MSG_FINISH );
					race_state = RS_FINISH;
				}
			}
			
			update_hud( HUD_LAP );
			race_ptr = &buf[0];
		}
		memcpy(curve,&curve_data[*race_ptr<<6],48);
		
		if( *race_ptr > 4 )
		{
			race_scroll++;
		}
		if( *race_ptr < 4 )
		{
			race_scroll--;
		}	
	}
	
	if( *race_ptr != 4 )
	{
		if( *race_ptr > 4 )
		{
			curve_acceleration = -((player_speed * (*race_ptr - 4)) >> 6);
		} else {
			curve_acceleration = (player_speed * (4 - *race_ptr)) >> 6;
		}
	}
	
	if( (player_x >> 3) <= 34 )
	{
		if( player_power > (player_speed >> 7) + 2 )
		{
			player_power -= (player_speed >> 7) + 2;
		} else {
			player_power = 0;
			if( race_state == RS_RACE )
			{
				show_message( MSG_POWEROUT );
				race_state = RS_POWEROUT;
			}
		}
				
		bounce_acceleration = 40;
		if( player_speed > 80 )
		{
			player_speed -= 80;
		} else {
			player_speed = 0;
		}
		set_sound( SND_HIT );
		update_hud( HUD_POWER );
	}
	if( (player_x >> 3) >= 119 )
	{
		if( player_power > (player_speed >> 7) + 2 )
		{
			player_power -= (player_speed >> 7) + 2;
		} else {
			player_power = 0;
			if( race_state == RS_RACE )
			{
				show_message( MSG_POWEROUT );
				race_state = RS_POWEROUT;
			}
		}
				
		bounce_acceleration = -40;
		if( player_speed > 80 )
		{
			player_speed -= 80;
		} else {
			player_speed = 0;
		}
		set_sound( SND_HIT );
		update_hud( HUD_POWER );
	}
		
	player_x += ((input_acceleration + curve_acceleration + bounce_acceleration) >> 1);
	if( input_acceleration != 0)
	{
		if( input_acceleration < 0 )
		{
			input_acceleration++;
		} else {
			input_acceleration--;
		}
	}
	if( curve_acceleration != 0)
	{
		if( curve_acceleration < 0 )
		{
			curve_acceleration++;
		} else {
			curve_acceleration--;
		}
	}
	if( bounce_acceleration != 0)
	{
		if( bounce_acceleration < 0 )
		{
			bounce_acceleration++;
		} else {
			bounce_acceleration--;
		}
	}
		
	//handle speed
	switch( player_range )
	{
		case 0:
			if( player_speed != 0 )
			{
				player_range = 1;
				speed_ptr += 25;
			}
			break;
		case 1:
			if( player_speed == 0 )
			{
				player_range = 0;
				speed_ptr -= 25;
			}
			if( player_speed > 62 )
			{
				player_range = 2;
				speed_ptr += 25;
			}
			break;
		case 2:
			if( player_speed <= 62 )
			{
				player_range = 1;
				speed_ptr -= 25;
			}
			if( player_speed > 124 )
			{
				player_range = 3;
				speed_ptr += 25;
			}
			break;
		case 3:
			if( player_speed <= 124 )
			{
				player_range = 2;
				speed_ptr -= 25;
			}
			if( player_speed > 186 )
			{
				player_range = 4;
				speed_ptr += 25;
			}
			break;
		case 4:
			if( player_speed <= 186 )
			{
				player_range = 3;
				speed_ptr -= 25;
			}
			if( player_speed > 248 )
			{
				player_range = 5;
				speed_ptr += 25;
			}
			break;
		case 5:
			if( player_speed <= 248 )
			{
				player_range = 4;
				speed_ptr -= 25;
			}
			break;	
	}
	
	player_count += *speed_ptr;
	if( player_count >= 0xC0 )
	{
		player_count -= 0xC0;
	}
	
	speed_ptr++;
	if( *speed_ptr == 0xFF )
	{
		speed_ptr -= 24;
	}
	
	update_hud( HUD_SPEED );
	update_hud( HUD_TIME );
	
	//draw player
	if( player_animation == 0 )
	{
		set_sprite_tile(SN_PLAYER1,ST_PLAYER1);
		set_sprite_tile(SN_PLAYER2,ST_PLAYER2);
		set_sprite_tile(SN_PLAYER3,ST_PLAYER3);
	} else {
		set_sprite_tile(SN_PLAYER1,ST_PLAYER4);
		set_sprite_tile(SN_PLAYER2,ST_PLAYER5);
		set_sprite_tile(SN_PLAYER3,ST_PLAYER6);
	}
	
	move_sprite(SN_PLAYER1,(player_x >> 3),112);
	move_sprite(SN_PLAYER2,(player_x >> 3)+8,112);
	move_sprite(SN_PLAYER3,(player_x >> 3)+16,112);
	
	//pause
	if( KEY_TICKED(J_START) && (race_state == RS_RACE) )
	{
		set_sound( SND_PAUSE );
		
		for( i = 0; i != 10; i++ )
		{
			update_sound();
			gbt_update();
			wait_vbl_done();
		}
		
		gbt_stop();
		
		do
		{
			UPDATE_KEYS();
			wait_vbl_done();
		} while( !KEY_TICKED(J_START) );
		
		gbt_play(race_music, MUSIC_BANK, 7);
	}
	
	//race finished
	if( (race_state != RS_RACE) && (player_speed == 0) )
	{
		game_state = GS_RACE_FINISHED;
	}
}

void run_race()
{
	UBYTE i;
	
	STAT_REG = 0x18;
	set_interrupts( VBL_IFLAG | LCD_IFLAG );
	
	init_race();
	init_player();
	init_sound();
	
	gbt_play(race_music, MUSIC_BANK, 7);
		
	SHOW_BKG;
	SHOW_WIN;
	SHOW_SPRITES;
	DISPLAY_ON;
	enable_interrupts();
	
	fade_from_white();
	
	for( i = 0; i != 100; i++ )
	{
		update_sound();
		gbt_update();
		wait_vbl_done();
	}
	
	hide_message();
	for( i = 0; i != 50; i++ )
	{
		update_sound();
		gbt_update();
		wait_vbl_done();
	}
	
	show_message( MSG_THREE );
	set_sound( SND_BEEP1 );
	for( i = 0; i != 50; i++ )
	{
		update_sound();
		gbt_update();
		wait_vbl_done();
	}
	
	show_message( MSG_TWO );
	set_sound( SND_BEEP1 );
	for( i = 0; i != 50; i++ )
	{
		update_sound();
		gbt_update();
		wait_vbl_done();
	}
	
	show_message( MSG_ONE );
	set_sound( SND_BEEP1 );
	for( i = 0; i != 50; i++ )
	{
		update_sound();
		gbt_update();
		wait_vbl_done();
	}
	
	show_message( MSG_GO );
	set_sound( SND_BEEP2 );
	for( i = 0; i != 50; i++ )
	{
		update_sound();
		gbt_update();
		wait_vbl_done();
	}
	hide_message();
	
	while( game_state == GS_RACE )
	{
		UPDATE_KEYS();
		update_player();
		update_race();
		
		update_sound();
		gbt_update();
		wait_vbl_done();
	}
	
	for( i = 0; i != 50; i++ )
	{
		update_player();
		update_sound();
		gbt_update();
		wait_vbl_done();
	}
	
	gbt_stop();
	fade_to_white();
	
	disable_interrupts();
	DISPLAY_OFF;
}